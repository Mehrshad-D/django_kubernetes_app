<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامه وب جنگو و کوبرنتیس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Fallback to Inter or generic sans-serif
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Ensure Inter is used */
            direction: rtl; /* Right-to-left for Persian */
            text-align: right; /* Align text to the right */
        }
        .message-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .message-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-500 to-teal-600 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-10 rounded-xl shadow-2xl text-center max-w-3xl w-full transform transition-all duration-500 hover:scale-105">
        <h1 class="text-5xl font-extrabold text-gray-800 mb-6 tracking-tight">
            به برنامه وب جنگو و کوبرنتیس خوش آمدید!
        </h1>
        <p class="text-xl text-gray-700 font-semibold mb-8">
            این برنامه تعامل با API کوبرنتیس، دیتابیس و شبیه‌سازی مقیاس‌پذیری خودکار را نشان می‌دهد.
        </p>
        <form style="display:none;">
        {% csrf_token %}
        </form>

        <div class="text-lg text-gray-600 mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">وضعیت پیکربندی کوبرنتیس:</h2>
            <p class="text-xl text-blue-600 font-medium">
                {% if kube_config_status == 'Loaded' %}
                    پیکربندی کوبرنیتس با موفقیت بارگذاری شد.
                {% else %}
                      وضعیت کوبرنیتس: {{ kube_config_status }}
                {% endif %}
            </p>
        </div>

       <div class="text-left mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">عملیات API کوبرنیتس:</h2>
    <div class="space-y-2">
        <a href="/pods/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">مشاهده پادها</a>
        <a href="/nodes/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">مشاهده نودها</a>
        <form action="/create-dummy-resource/" method="post">
            {% csrf_token %}
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">ایجاد منبع ساختگی</button>
        </form>
        <a href="/metrics/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">مشاهده متریک‌های شبیه‌سازی شده</a>
    </div>
</div>

        <!-- Database Interaction Section -->
        <div class="text-left mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">تعامل با دیتابیس PostgreSQL:</h2>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">ذخیره یک پیام جدید:</h3>
                <input type="text" id="messageInput" placeholder="پیام خود را اینجا وارد کنید..."
                       class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3" />
                <button onclick="saveMessage()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1">
                    ذخیره پیام
                </button>
                <p id="saveStatus" class="mt-2 text-sm text-gray-600"></p>
            </div>

            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-3">پیام‌های ذخیره شده:</h3>
                <button onclick="listMessages()"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 mb-3">
                    بارگذاری پیام‌ها
                </button>
                <div id="messagesList" class="max-h-60 overflow-y-auto bg-white p-4 rounded-md border border-gray-300">
                    <p class="text-gray-500">پیام‌ها در اینجا نمایش داده می‌شوند.</p>
                </div>
                <p id="listStatus" class="mt-2 text-sm text-gray-600"></p>
            </div>
        </div>

        <p class="text-md text-gray-500 mt-6">
            با این برنامه می‌توانید تعاملات کوبرنیتس، قابلیت مقیاس‌پذیری خودکار و اتصال به دیتابیس را آزمایش کنید.
        </p>
    </div>

    <script>
        // Function to get CSRF token from Django's cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function saveMessage() {
            const messageInput = document.getElementById('messageInput');
            const saveStatus = document.getElementById('saveStatus');
            const messageText = messageInput.value;

            if (!messageText) {
                saveStatus.textContent = 'متن پیام نمی‌تواند خالی باشد.';
                saveStatus.className = 'mt-2 text-sm text-red-600';
                return;
            }

            saveStatus.textContent = 'در حال ذخیره‌سازی...';
            saveStatus.className = 'mt-2 text-sm text-blue-600';

            // try {
            //     const response = await fetch('/messages/save/', {
            //         method: 'POST',
            //         headers: {
            //             'Content-Type': 'application/x-www-form-urlencoded',
            //             'X-CSRFToken': getCookie('csrftoken'), // Include CSRF token
            //         },
            //         body: `message_text=${encodeURIComponent(messageText)}`,
            //         credentials: 'same-origin'
            //     });
            //     const data = await response.json();

            //     if (response.ok) {
            //         saveStatus.textContent = data.message;
            //         saveStatus.className = 'mt-2 text-sm text-green-600';
            //         messageInput.value = ''; // Clear input field
            //         listMessages(); // Refresh message list after saving
            //     } else {
            //         saveStatus.textContent = `خطا: ${data.message}`;
            //         saveStatus.className = 'mt-2 text-sm text-red-600';
            //     }
            // } catch (error) {
            //     saveStatus.textContent = `خطا در شبکه: ${error}`;
            //     saveStatus.className = 'mt-2 text-sm text-red-600';
            // }

            try {
                // const response = await fetch('https://my-site.darkube.app/messages/save/', {
                 const response = await fetch('https://repo-test.darkube.app/messages/save/', {    
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'), // CSRF from cookie
                },
                body: `message_text=${encodeURIComponent(messageText)}`,
                credentials: 'include'  // 🔥 CRITICAL under HTTPS!
                });

                const text = await response.text();
                let data = {};

                try {
                    data = JSON.parse(text);  // Try to parse JSON
                } catch (jsonError) {
                    console.error("❌ JSON parse failed. Raw response:", text);
                    throw new Error("سرور پاسخ معتبر JSON نداد.");
                }

                if (response.ok) {
                    saveStatus.textContent = data.message;
                    saveStatus.className = 'mt-2 text-sm text-green-600';
                    messageInput.value = ''; // Clear input field
                    listMessages(); // Refresh message list
                } else {
                    saveStatus.textContent = `خطا: ${data.message}`;
                    saveStatus.className = 'mt-2 text-sm text-red-600';
                }
            } catch (error) {
                console.error("🚨 Fetch error:", error);
                saveStatus.textContent = `خطا در شبکه: ${error.message}`;
                saveStatus.className = 'mt-2 text-sm text-red-600';
            }   
        }

        async function listMessages() {
            const messagesListDiv = document.getElementById('messagesList');
            const listStatus = document.getElementById('listStatus');
            messagesListDiv.innerHTML = '<p class="text-gray-500">در حال بارگذاری پیام‌ها...</p>';
            listStatus.textContent = ''; // Clear previous status

            try {
                const response = await fetch('/messages/list/');
                const data = await response.json();

                if (response.ok) {
                    if (data.messages && data.messages.length > 0) {
                        messagesListDiv.innerHTML = ''; // Clear existing content
                        data.messages.forEach(msg => {
                            const p = document.createElement('p');
                            p.className = 'message-item text-gray-700';
                            p.innerHTML = `<span>${msg.text}</span> <span class="text-gray-500 text-sm">${msg.created_at}</span>`;
                            messagesListDiv.appendChild(p);
                        });
                    } else {
                        messagesListDiv.innerHTML = '<p class="text-gray-500">هیچ پیامی ذخیره نشده است.</p>';
                    }
                    listStatus.textContent = 'پیام‌ها با موفقیت بارگذاری شدند.';
                    listStatus.className = 'mt-2 text-sm text-green-600';
                } else {
                    messagesListDiv.innerHTML = `<p class="text-red-600">خطا در بارگذاری پیام‌ها: ${data.message || 'خطای ناشناخته'}</p>`;
                    listStatus.textContent = `خطا: ${data.message || 'خطای ناشناخته'}`;
                    listStatus.className = 'mt-2 text-sm text-red-600';
                }
            } catch (error) {
                messagesListDiv.innerHTML = `<p class="text-red-600">خطا در شبکه: ${error}</p>`;
                listStatus.textContent = `خطا در شبکه: ${error}`;
                listStatus.className = 'mt-2 text-sm text-red-600';
            }
        }

        // Load messages when the page loads
        document.addEventListener('DOMContentLoaded', listMessages);
    </script>
</body>
</html>
