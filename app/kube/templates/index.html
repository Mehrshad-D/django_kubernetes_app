<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙˆØ¨ Ø¬Ù†Ú¯Ùˆ Ùˆ Ú©ÙˆØ¨Ø±Ù†ØªÛŒØ³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Fallback to Inter or generic sans-serif
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Ensure Inter is used */
            direction: rtl; /* Right-to-left for Persian */
            text-align: right; /* Align text to the right */
        }
        .message-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .message-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-500 to-teal-600 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-10 rounded-xl shadow-2xl text-center max-w-3xl w-full transform transition-all duration-500 hover:scale-105">
        <h1 class="text-5xl font-extrabold text-gray-800 mb-6 tracking-tight">
            Ø¨Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙˆØ¨ Ø¬Ù†Ú¯Ùˆ Ùˆ Ú©ÙˆØ¨Ø±Ù†ØªÛŒØ³ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!
        </h1>
        <p class="text-xl text-gray-700 font-semibold mb-8">
            Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªØ¹Ø§Ù…Ù„ Ø¨Ø§ API Ú©ÙˆØ¨Ø±Ù†ØªÛŒØ³ØŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ùˆ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ù‚ÛŒØ§Ø³â€ŒÙ¾Ø°ÛŒØ±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
        </p>
        <form style="display:none;">
        {% csrf_token %}
        </form>

        <div class="text-lg text-gray-600 mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ú©ÙˆØ¨Ø±Ù†ØªÛŒØ³:</h2>
            <p class="text-xl text-blue-600 font-medium">
                {% if kube_config_status == 'Loaded' %}
                    Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ú©ÙˆØ¨Ø±Ù†ÛŒØªØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.
                {% else %}
                      ÙˆØ¶Ø¹ÛŒØª Ú©ÙˆØ¨Ø±Ù†ÛŒØªØ³: {{ kube_config_status }}
                {% endif %}
            </p>
        </div>

       <div class="text-left mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Ø¹Ù…Ù„ÛŒØ§Øª API Ú©ÙˆØ¨Ø±Ù†ÛŒØªØ³:</h2>
    <div class="space-y-2">
        <a href="/pods/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø§Ø¯Ù‡Ø§</a>
        <a href="/nodes/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ÙˆØ¯Ù‡Ø§</a>
        <form action="/create-dummy-resource/" method="post">
            {% csrf_token %}
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Ø§ÛŒØ¬Ø§Ø¯ Ù…Ù†Ø¨Ø¹ Ø³Ø§Ø®ØªÚ¯ÛŒ</button>
        </form>
        <a href="/metrics/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡</a>
    </div>
</div>

        <!-- Database Interaction Section -->
        <div class="text-left mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ØªØ¹Ø§Ù…Ù„ Ø¨Ø§ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ PostgreSQL:</h2>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Ø°Ø®ÛŒØ±Ù‡ ÛŒÚ© Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯:</h3>
                <input type="text" id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."
                       class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3" />
                <button onclick="saveMessage()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1">
                    Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù…
                </button>
                <p id="saveStatus" class="mt-2 text-sm text-gray-600"></p>
            </div>

            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡:</h3>
                <button onclick="listMessages()"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 mb-3">
                    Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
                </button>
                <div id="messagesList" class="max-h-60 overflow-y-auto bg-white p-4 rounded-md border border-gray-300">
                    <p class="text-gray-500">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
                </div>
                <p id="listStatus" class="mt-2 text-sm text-gray-600"></p>
            </div>
        </div>

        <p class="text-md text-gray-500 mt-6">
            Ø¨Ø§ Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØ¹Ø§Ù…Ù„Ø§Øª Ú©ÙˆØ¨Ø±Ù†ÛŒØªØ³ØŒ Ù‚Ø§Ø¨Ù„ÛŒØª Ù…Ù‚ÛŒØ§Ø³â€ŒÙ¾Ø°ÛŒØ±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§ Ø¢Ø²Ù…Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.
        </p>
    </div>

    <script>
        // Function to get CSRF token from Django's cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function saveMessage() {
            const messageInput = document.getElementById('messageInput');
            const saveStatus = document.getElementById('saveStatus');
            const messageText = messageInput.value;

            if (!messageText) {
                saveStatus.textContent = 'Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.';
                saveStatus.className = 'mt-2 text-sm text-red-600';
                return;
            }

            saveStatus.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ...';
            saveStatus.className = 'mt-2 text-sm text-blue-600';

            // try {
            //     const response = await fetch('/messages/save/', {
            //         method: 'POST',
            //         headers: {
            //             'Content-Type': 'application/x-www-form-urlencoded',
            //             'X-CSRFToken': getCookie('csrftoken'), // Include CSRF token
            //         },
            //         body: `message_text=${encodeURIComponent(messageText)}`,
            //         credentials: 'same-origin'
            //     });
            //     const data = await response.json();

            //     if (response.ok) {
            //         saveStatus.textContent = data.message;
            //         saveStatus.className = 'mt-2 text-sm text-green-600';
            //         messageInput.value = ''; // Clear input field
            //         listMessages(); // Refresh message list after saving
            //     } else {
            //         saveStatus.textContent = `Ø®Ø·Ø§: ${data.message}`;
            //         saveStatus.className = 'mt-2 text-sm text-red-600';
            //     }
            // } catch (error) {
            //     saveStatus.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡: ${error}`;
            //     saveStatus.className = 'mt-2 text-sm text-red-600';
            // }

            try {
                // const response = await fetch('https://my-site.darkube.app/messages/save/', {
                 const response = await fetch('https://repo-test.darkube.app/messages/save/', {    
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'), // CSRF from cookie
                },
                body: `message_text=${encodeURIComponent(messageText)}`,
                credentials: 'include'  // ğŸ”¥ CRITICAL under HTTPS!
                });

                const text = await response.text();
                let data = {};

                try {
                    data = JSON.parse(text);  // Try to parse JSON
                } catch (jsonError) {
                    console.error("âŒ JSON parse failed. Raw response:", text);
                    throw new Error("Ø³Ø±ÙˆØ± Ù¾Ø§Ø³Ø® Ù…Ø¹ØªØ¨Ø± JSON Ù†Ø¯Ø§Ø¯.");
                }

                if (response.ok) {
                    saveStatus.textContent = data.message;
                    saveStatus.className = 'mt-2 text-sm text-green-600';
                    messageInput.value = ''; // Clear input field
                    listMessages(); // Refresh message list
                } else {
                    saveStatus.textContent = `Ø®Ø·Ø§: ${data.message}`;
                    saveStatus.className = 'mt-2 text-sm text-red-600';
                }
            } catch (error) {
                console.error("ğŸš¨ Fetch error:", error);
                saveStatus.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡: ${error.message}`;
                saveStatus.className = 'mt-2 text-sm text-red-600';
            }   
        }

        async function listMessages() {
            const messagesListDiv = document.getElementById('messagesList');
            const listStatus = document.getElementById('listStatus');
            messagesListDiv.innerHTML = '<p class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§...</p>';
            listStatus.textContent = ''; // Clear previous status

            try {
                const response = await fetch('/messages/list/');
                const data = await response.json();

                if (response.ok) {
                    if (data.messages && data.messages.length > 0) {
                        messagesListDiv.innerHTML = ''; // Clear existing content
                        data.messages.forEach(msg => {
                            const p = document.createElement('p');
                            p.className = 'message-item text-gray-700';
                            p.innerHTML = `<span>${msg.text}</span> <span class="text-gray-500 text-sm">${msg.created_at}</span>`;
                            messagesListDiv.appendChild(p);
                        });
                    } else {
                        messagesListDiv.innerHTML = '<p class="text-gray-500">Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                    }
                    listStatus.textContent = 'Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯.';
                    listStatus.className = 'mt-2 text-sm text-green-600';
                } else {
                    messagesListDiv.innerHTML = `<p class="text-red-600">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: ${data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}</p>`;
                    listStatus.textContent = `Ø®Ø·Ø§: ${data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}`;
                    listStatus.className = 'mt-2 text-sm text-red-600';
                }
            } catch (error) {
                messagesListDiv.innerHTML = `<p class="text-red-600">Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡: ${error}</p>`;
                listStatus.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡: ${error}`;
                listStatus.className = 'mt-2 text-sm text-red-600';
            }
        }

        // Load messages when the page loads
        document.addEventListener('DOMContentLoaded', listMessages);
    </script>
</body>
</html>
